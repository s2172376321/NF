<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ngrok 連結 + 建立商品明細</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- dayjs：產生唯一編號 -->
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <!-- PapaParse：解析 CSV -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    body{background:#f4f6fb;font-family:'Segoe UI','Microsoft JhengHei',Arial,sans-serif;margin:0;padding:0;}
    .container-box{max-width:600px;margin:40px auto;background:#fff;border-radius:18px;
                   box-shadow:0 8px 32px rgba(60,72,88,.18);padding:40px 32px;}
    h2{color:#2d3a4b;margin-bottom:24px;font-size:2em;letter-spacing:2px;text-align:center;}
    /* 共用大按鈕 */
    .big-btn{display:block;width:100%;padding:22px 0;font-size:1.25em;font-weight:600;color:#fff;
             background:linear-gradient(90deg,#3a7bd5 0%,#00d2ff 100%);border:none;border-radius:12px;
             box-shadow:0 4px 16px rgba(58,123,213,.12);text-decoration:none;transition:.2s;
             letter-spacing:1px;text-align:center;}   /* ← 置中 */
    .big-btn:hover,.big-btn:focus{background:linear-gradient(90deg,#005c97 0%,#363795 100%);
                                  transform:translateY(-2px) scale(1.03);box-shadow:0 8px 24px rgba(58,123,213,.18);}
    .group-title{margin:24px 0 8px;font-weight:700;color:#fa541c;}
    ul.links{list-style:none;padding-left:0;margin:0 0 8px 0;}
    ul.links li{margin-bottom:8px;}
    ul.links a{color:#005c97;text-decoration:none;font-weight:600;}
    ul.links a:hover{text-decoration:underline;}
    /* 自動完成選單 */
    #suggestList{position:absolute;z-index:10;width:100%;}
  </style>
</head>
<body>

  <!-- 區塊 1：ngrok 連結 -->
  <div class="container-box">
    <h2>ngrok 連結</h2>

    <ul class="list-unstyled">
      <li class="mb-3"><a class="big-btn" href="https://6ca8-218-34-110-52.ngrok-free.app" target="_blank">冷凍庫庫存 (後端)</a></li>
      <li class="mb-3"><a class="big-btn" href="https://2966-218-34-110-52.ngrok-free.app" target="_blank">採收資料 &amp; 資材使用</a></li>
    </ul>

    <button id="showLinksBtn" class="big-btn mb-3">顯示領用連結</button>
    <div id="resultArea"></div>
  </div>

  <!-- 區塊 2：建立商品明細 -->
  <div class="container-box mt-4">
    <h2>建立商品明細</h2>

    <!-- step 1：關鍵字 -->
    <div class="mb-3 position-relative">
      <label class="form-label">商品關鍵字</label>
      <input id="prodKeyword" type="text" class="form-control" placeholder="輸入關鍵字">
      <div id="suggestList" class="list-group"></div>
    </div>

    <!-- step 2：重量 -->
    <div class="mb-3" style="max-width:200px;">
      <label class="form-label">重量 / 斤</label>
      <input id="prodWeight" type="number" min="0" step="0.1" class="form-control">
    </div>

    <button id="addDetailBtn" class="big-btn mb-4">新增一件明細</button>

    <!-- 明細表 -->
    <div class="table-responsive">
      <table class="table table-bordered align-middle">
        <thead class="table-light">
          <tr>
            <th>#</th><th>商品編號</th><th>品名</th><th>中分類</th><th>單價</th>
            <th>重量</th><th>小計</th><th></th>
          </tr>
        </thead>
        <tbody id="detailTableBody"></tbody>
      </table>
    </div>
    <h5 id="totalSum" class="text-end mb-3"></h5>

    <button id="finishBtn" class="big-btn">完成並產生唯一編號</button>
    <div id="uidBox" class="mt-3 fw-bold fs-5 text-center text-success"></div>
  </div>

  <!-- ================== JavaScript ================== -->
  <script>
  /* ---------- 區塊 1：ngrok 連結 ---------- */
  const BASE_URL   = 'https://6ca8-218-34-110-52.ngrok-free.app';
  const showBtn    = document.getElementById('showLinksBtn');
  const resultArea = document.getElementById('resultArea');

  showBtn.addEventListener('click', async () => {
    showBtn.disabled = true;
    showBtn.textContent = '載入中…';
    try{
      const res = await fetch(`${BASE_URL}/api/inventory/claim-links?ngrok-skip-browser-warning=true`,
                              { headers:{'ngrok-skip-browser-warning':'true'} });
      if(!res.ok) throw new Error('無法取得資料');
      const data = await res.json();

      // 分組
      const groups = { '真空包':[], '業務包':[], '其他':[] };
      data.forEach(item=>{
        if(item.text.includes('真空包'))      groups['真空包'].push(item);
        else if(item.text.includes('業務包')) groups['業務包'].push(item);
        else                                  groups['其他'].push(item);
      });

      // 產生 HTML
      resultArea.innerHTML = '';
      Object.keys(groups).forEach(key=>{
        if(!groups[key].length) return;
        const title = document.createElement('div');
        title.className = 'group-title';
        title.textContent = key;
        resultArea.appendChild(title);

        const ul = document.createElement('ul');
        ul.className = 'links';
        groups[key].forEach(item=>{
          const li = document.createElement('li');
          const a  = document.createElement('a');
          a.textContent = item.text.replace(/\+/g,'  ');
          a.href   = item.link;
          a.target = '_blank';
          li.appendChild(a);
          ul.appendChild(li);
        });
        resultArea.appendChild(ul);
      });

    }catch(err){ alert('載入失敗：'+err.message); }
    finally{
      showBtn.disabled = false;
      showBtn.textContent = '顯示領用連結';
    }
  });

  /* ---------- 區塊 2：商品明細 ---------- */
  // 解析 CSV
  let products = [];
  Papa.parse('products.csv', {
    header:true, download:true, skipEmptyLines:true,
    complete: res => { products = res.data; }
  });

  const $ = id => document.getElementById(id);
  const details = [];

  // 自動完成
  $('prodKeyword').addEventListener('input', () => {
    const kw = $('prodKeyword').value.trim();
    const list = $('suggestList');
    list.innerHTML = '';
    if(!kw) return;

    products.filter(p => p['規    格'].includes(kw))  // 只用關鍵字過濾
            .slice(0,10).forEach(p=>{
      const a = document.createElement('a');
      a.className='list-group-item list-group-item-action';
      a.textContent=`${p['規    格']}（${p['售價']}元）`;
      a.onclick=()=>{
        $('prodKeyword').value = p['規    格'];
        $('prodKeyword').dataset.code  = p['商品編號'];
        $('prodKeyword').dataset.price = p['售價'];
        $('prodKeyword').dataset.cat   = p['中分類'];
        list.innerHTML='';
      };
      list.appendChild(a);
    });
  });

  // 新增明細
  $('addDetailBtn').onclick = () => {
    const code   = $('prodKeyword').dataset.code;
    const name   = $('prodKeyword').value.trim();
    const price  = parseFloat($('prodKeyword').dataset.price);
    const cat    = $('prodKeyword').dataset.cat;
    const weight = parseFloat($('prodWeight').value);

    if(!code||!name||!weight){
      return alert('請完整輸入');
    }
    const subtotal = price * weight;
    details.push({code,name,cat,price,weight,subtotal});
    renderTable();

    // reset
    $('prodKeyword').value='';
    $('prodKeyword').dataset.code='';
    $('prodKeyword').dataset.price='';
    $('prodKeyword').dataset.cat='';
    $('prodWeight').value='';
  };

  // 渲染表格
  function renderTable(){
    const body = $('detailTableBody');
    body.innerHTML = details.map((d,i)=>`
      <tr>
        <td>${i+1}</td><td>${d.code}</td><td>${d.name}</td><td>${d.cat}</td>
        <td>${d.price}</td><td>${d.weight}</td><td>${d.subtotal}</td>
        <td><button class="btn btn-sm btn-danger" onclick="removeItem(${i})">刪除</button></td>
      </tr>
    `).join('');
    const tot = details.reduce((s,d)=>s+d.subtotal,0);
    $('totalSum').textContent = '總計：' + tot + ' 元';
  }
  window.removeItem = idx => { details.splice(idx,1); renderTable(); };

  // 產生唯一編號
  $('finishBtn').onclick = () => {
    if(!details.length) return alert('尚未新增任何商品！');
    const uid = 'NF' + dayjs().format('YYYYMMDDHHmmss') +
                Math.floor(Math.random()*9000+1000);
    $('uidBox').textContent = '此明細編號：' + uid;
    // 可在此處 fetch POST details 到後端
  };
  </script>
</body>
</html>
